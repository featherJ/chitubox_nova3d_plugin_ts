module.exports=function(e){var t={};function i(s){if(t[s])return t[s].exports;var n=t[s]={i:s,l:!1,exports:{}};return e[s].call(n.exports,n,n.exports,i),n.l=!0,n.exports}return i.m=e,i.c=t,i.d=function(e,t,s){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(s,n,function(t){return e[t]}.bind(null,n));return s},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=14)}([function(e,t){e.exports=require("fs")},,function(e,t){e.exports=require("path")},,,,,,,,,,,,function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Nova3DPlugin=void 0;const s=i(15),n=i(16),r=i(17),a=i(2),o=i(0);class l{constructor(e){this.tempPath=e,this.gCodeParser=new s.RunGCodeParser,this.gCodeGenerator=new n.GCodeGenerator;try{this.buildGCode(),this.buildImages()}catch(t){o.writeFileSync(a.join(e,"error.log"),t.stack,"utf8")}}buildGCode(){var e=a.join(this.tempPath,"run.gcode");this.gCodeParser.parse(e),this.gCodeGenerator.build(this.gCodeParser.header,this.gCodeParser.start,this.gCodeParser.layers),o.unlinkSync(e);var t=a.join(this.tempPath,"nova3d.gcode");o.writeFileSync(t,this.gCodeGenerator.content,"utf8")}buildImages(){var e=new r.ConverterPool(4);e.init();for(var t=o.readdirSync(this.tempPath),i=0;i<t.length;i++){var s=t[i],n=a.join(this.tempPath,s);if(".png"==a.extname(n).toLocaleLowerCase()&&-1==s.indexOf("preview")){var l=a.basename(n).split(".")[0],h=parseInt(l);l==h.toString()&&e.addSlice({path:n,index:h})}}(new Date).getTime(),e.run().then(()=>{e.exit()})}}t.Nova3DPlugin=l;let h=process.argv.splice(2)[0];h&&new l(h)},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RunGCodeParser=void 0;const s=i(0);t.RunGCodeParser=class{constructor(){}get header(){return this._header}get start(){return this._start}get layers(){return this._layers}parse(e){let t=s.readFileSync(e,"utf8").split(";START_GCODE_BEGIN"),i=t[0],n=t[1].split(";START_GCODE_END"),r=n[0],a=n[1];this.parseHeader(i),this._start=r.trim(),this.parseLayers(a)}parseHeader(e){let t=e.split(";");this._header={};for(let e=0;e<t.length;e++){let i=t[e];if(i=i.trim()){let e=i.split(":"),t=e[0],s=e[1];"fileName"==t&&(s=(s=s.split("#")[0]).trim()),this._header[t]=s}}}parseLayers(e){let t=[],i=e.split(";LAYER_END");for(let e=0;e<i.length;e++){let s=i[e];if(s=s.trim()){if(-1!=s.indexOf(";END_GCODE_BEGIN"))break;if(-1!=s.indexOf(";END_GCODE_END"))break;let e=[],i={},n=s.split("\n"),r=!1;for(let t=0;t<n.length;t++){let s=n[t].trim();if(0==s.indexOf(";LAYER_START:")){let e=s.slice(";LAYER_START:".length);i.index=parseInt(e)}if(0==s.indexOf("G0")&&e.push(s),0==s.indexOf("G4 P")){let e=parseFloat(s.slice("G4 P".length));r?i.exposure_time=e:i.light_delay=e}if(-1!=s.indexOf("light on")){r=!0;let e=s.split(";")[0],t=parseFloat(e.slice("M106 S".length));i.light_pwm=t}}let a=this.parseGData(e[0]),o=this.parseGData(e[1]),l=null,h=null;a.pos>=o.pos?(l=a,h=o):(l=o,h=a),i.rise_pos=l.pos,i.rise_speed=l.speed,i.fall_pos=h.pos,i.fall_speed=h.speed,t.push(i)}}this._layers=t}parseGData(e){let t=e.split(" ");return{pos:parseFloat(t[1].slice(1)),speed:parseFloat(t[2].slice(1))}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GCodeGenerator=void 0,t.GCodeGenerator=class{constructor(){this.transitionLayerStartIndex=0,this.transitionLayerEndIndex=0,this.analyseSuccess=!1,this.startRiseSpeed=-1,this.endRiseSpeed=-1,this.startRiseDist=-1,this.endRiseDist=-1,this.startFallSpeed=-1,this.endFallSpeed=-1,this.startlightDelay=-1,this.endLightDelay=-1,this.startExposureTime=-1,this.endExposureTime=-1}get content(){return this._content}build(e,t,i){this._content="",this.header=e,this.start=t,this.layers=i,this.buildHeader(),this.buildStart(),this.buildLayers(),this.buildLastLayers(),this.buildLast()}buildHeader(){this._content+="; create by plugin (Nova3d Nodejs-TS):1.0.0\n",this._content+=";(****Build and Slicing Parameters****)\n",this._content+=`;(X Resolution            = ${this.header.resolutionX} )\n`,this._content+=`;(Y Resolution            = ${this.header.resolutionY} )\n`,this._content+=`;(Layer Thickness         = ${this.header.layerHeight} mm )\n`,this._content+=`;(Layer Time              = ${1e3*this.header.normalExposureTime} ms )\n`,this._content+=";(Render Outlines         = False\n",this._content+=";(Outline Width Inset     = 2\n",this._content+=";(Outline Width Outset    = 0\n",this._content+=`;(Bottom Layers Time      = ${this.header.bottomLayerExposureTime} ms )\n`,this._content+=`;(Number of Bottom Layers = ${this.header.bottomLayerCount} )\n`,this._content+=";(Blanking Layer Time     = 0 ms )\n",this._content+=";(Build Direction         = Bottom_Up)\n",this._content+=";(Lift Distance           = 5 mm )\n",this._content+=";(Slide/Tilt Value        = 0)\n",this._content+=";(Use Mainlift GCode Tab  = False)\n",this._content+=`;(Wait After Stop         = ${this.header.lightOffTime}s )\n`,this._content+=`;(Z Lift Feed Rate        = ${this.header.normalLayerLiftSpeed} mm/s )\n`,this._content+=`;(Z Bottom Lift Feed Rate = ${this.header.bottomLayerLiftSpeed} mm/s )\n`,this._content+=`;(Z Lift Retract Rate     = ${this.header.normalDropSpeed} mm/s )\n`,this._content+=";(Flip X                  = True)\n",this._content+=";(Flip Y                  = True)\n",this._content+=`;Number of Slices         = ${this.header.totalLayer}\n`,this._content+=";(****Machine Configuration ******)\n",this._content+=`;(Platform X Size         = ${this.header.machineX}mm )\n`,this._content+=`;(Platform Y Size         = ${this.header.machineY}mm )\n`,this._content+=`;(Platform Z Size         = ${this.header.machineZ}mm )\n`,this._content+=";(Max X Feedrate          = 240mm/s )\n",this._content+=";(Max Y Feedrate          = 240mm/s )\n",this._content+=";(Max Z Feedrate          = 240mm/s )\n",this._content+=";(Machine Type            = UV_LCD)\n"}buildStart(){this._content+="\n",this._content+="G28\n",this._content+="G21 ;Set units to be mm\n",this._content+="G91 ;Relative Positioning\n",this._content+="M17 ;Enable motors\n",this._content+="<Slice> Blank\n",this._content+="M106 S0\n"}buildLayers(){this.analyseLayers();for(var e=0;e<this.layers.length;e++)this.buildLayer(this.layers[e])}analyseLayers(){this.analyseSuccess=!1,this.transitionLayerStartIndex=parseInt(this.header.bottomLayerCount);for(var e=this.transitionLayerStartIndex;e<this.layers.length-1;e++){var t=this.layers[e],i=this.layers[e+1];if(t.exposure_time==i.exposure_time){this.transitionLayerEndIndex=e-1;break}}if(this.transitionLayerStartIndex>0&&this.transitionLayerEndIndex>this.transitionLayerStartIndex&&this.transitionLayerEndIndex<this.layers.length-1){var s=null,n=null;try{s=this.layers[this.transitionLayerStartIndex-1],n=this.layers[this.transitionLayerEndIndex+1]}catch(e){}s&&n&&(this.analyseSuccess=!0,this.startRiseSpeed=s.rise_speed,this.endRiseSpeed=n.rise_speed,this.startFallSpeed=s.fall_speed,this.endFallSpeed=n.fall_speed,this.startlightDelay=s.light_delay,this.endLightDelay=n.light_delay,this.startExposureTime=s.exposure_time,this.endExposureTime=n.exposure_time,this.startRiseDist=s.rise_pos-s.fall_pos,this.endRiseDist=n.rise_pos-n.fall_pos)}}getTransitionValue(e,t,i){var s=e+(t-e)/(this.transitionLayerEndIndex+1-(this.transitionLayerStartIndex-1))*(i-(this.transitionLayerStartIndex-1));return Math.floor(10*s)/10}buildLayer(e){this._content+="\n",this._content+=`;<Slice> ${e.index}\n`,this._content+=`M106 S${e.light_pwm}\n`;var t;t=this.analyseSuccess&&e.index>=this.transitionLayerStartIndex&&e.index<=this.transitionLayerEndIndex?this.getTransitionValue(this.startExposureTime,this.endExposureTime,e.index):e.exposure_time,this._content+=`;<Delay> ${t}\n`,this._content+="M106 S0\n",this._content+=";<Slice> Blank\n";var i=0;i=this.analyseSuccess&&e.index>=this.transitionLayerStartIndex&&e.index<=this.transitionLayerEndIndex?this.getTransitionValue(this.startRiseDist,this.endRiseDist,e.index):e.rise_pos-e.fall_pos;var s=parseFloat(this.header.layerHeight)-i;i=Math.ceil(1e7*i)/1e7,s=Math.ceil(1e7*s)/1e7;var n=0,r=0;this.analyseSuccess&&e.index>=this.transitionLayerStartIndex&&e.index<=this.transitionLayerEndIndex?(n=this.getTransitionValue(this.startRiseSpeed,this.endRiseSpeed,e.index),r=this.getTransitionValue(this.startFallSpeed,this.endFallSpeed,e.index)):(n=e.rise_speed,r=e.fall_speed),this._content+=`G1 Z${i} F${n}\n`,this._content+=`G1 Z${s} F${r}\n`;var a=0;a=i/(n/60)*1e3+-s/(r/60)*1e3+(this.analyseSuccess&&e.index>=this.transitionLayerStartIndex&&e.index<=this.transitionLayerEndIndex?this.getTransitionValue(this.startlightDelay,this.endLightDelay,e.index):e.light_delay),a=Math.floor(a),this._content+=`;<Delay> ${a}\n`}buildLastLayers(){var e=parseInt(this.header.totalLayer)-this.layers.length,t={},i=this.layers[this.layers.length-1];t.index=i.index,t.rise_pos=i.rise_pos,t.rise_speed=i.rise_speed,t.fall_pos=i.fall_pos,t.fall_speed=i.fall_speed,t.light_delay=i.light_delay,t.light_pwm=i.light_pwm,t.exposure_time=i.exposure_time;for(var s=0;s<e;s++)t.index++,this.buildLayer(t)}buildLast(){this._content+="\n",this._content+="M18 ;Disable Motors\n",this._content+="M106 S0\n",this._content+="G1 Z80\n",this._content+=";<Completed>\n"}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConverterPool=void 0;const s=i(18),n=i(2);t.ConverterPool=class{constructor(e){this.getConverterFuncs=[],this.slices=[],this.completeNum=0,this.maxSize=e,this.pool=[]}getConverter(){return new Promise((e,t)=>{if(this.pool.length<this.maxSize){let t=s.createChildProcess(n.resolve(__dirname,"./converter.node.js"));this.pool.push(t),e({target:t})}else this.getConverterFuncs.push(e)})}converterComplete(e){this.getConverterFuncs.length>0&&this.getConverterFuncs.pop()({target:e})}convert(e){return this.getConverter().then(t=>{var i=t.target;return i.convert(e).then(e=>(this.converterComplete(i),e))})}init(){this.slices=[],this.completeNum=0}addSlice(e){this.slices.push(e)}run(){return this.completeNum=0,new Promise((e,t)=>{for(let t=0;t<this.slices.length;t++)this.convert(this.slices[t]).then(t=>{this.completeNum++,this.completeNum==this.slices.length&&e()})})}exit(){for(let e=0;e<this.pool.length;e++)this.pool[e].exit()}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createChildProcess=t.NodeProcessOwner=void 0;const s=i(19);class n extends class{constructor(e){this.callIndex=0,this.callbackMap={},this.error_handler=this.error_handler.bind(this),this.exit_handler=this.exit_handler.bind(this),this.message_handler=this.message_handler.bind(this),this.child=s.fork(e),this.child.addListener("error",this.error_handler),this.child.addListener("exit",this.exit_handler),this.child.addListener("message",this.message_handler)}error_handler(e){}exit_handler(e,t){}message_handler(e){var t=e.type;if("custom"!=t){var i=e.funcName,s=i+"_"+e.callIndex,n=this.callbackMap[s];if(delete this.callbackMap[s],n)if("result"==t){var r=e.result;n.resolve(r)}else if("error"==t){var a=e.error;n.reject(a)}else"null"==t&&n.reject(`Method ${i} was not found in the child process`)}else{var o=e.messageId,l=e.data;this.onReceived(o,l)}}onReceived(e,t){this.onReceiveHandler&&this.onReceiveHandler(e,t)}call(e,t){var i=this.callIndex++;return this.send({funcName:e,callIndex:i,args:t}),new Promise((t,s)=>{this.callbackMap[e+"_"+i]={resolve:t,reject:s}})}send(e){this.child&&this.child.connected&&this.child.send(e)}}{}t.NodeProcessOwner=n,t.createChildProcess=function(e,t){var i=new n(e);return i.onReceiveHandler=t,new Proxy(i,{get:(e,t)=>t in e?e[t]:function(...i){return e.call(t,i)}})}},function(e,t){e.exports=require("child_process")}]);